<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>pyxterm.js</title>
  <style>
    html {
      font-family: arial;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/xterm@4.11.0/css/xterm.css" />

  <script defer src="https://edrys-org.github.io/edrys/module/vendor/alpine.min.js"></script>
  <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/water.min.css" />
  <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/open-iconic/css/open-iconic.min.css" />
  <script src="https://edrys-org.github.io/edrys/module/edrys.js"></script>

</head>

<body>
  <span style="font-size: 1.4em">pyxterm.js</span>&nbsp;&nbsp;&nbsp;
  <span style="font-size: small">status:
    <span style="font-size: small" id="status">connecting...</span></span>

  <div style="width: 100%; height: 90%" id="terminal"></div>

  <p style="text-align: right; font-size: small">
    built by <a href="https://chadsmith.dev">Chad Smith</a>
    <a href="https://github.com/cs01">GitHub</a>
  </p>
  <!-- xterm -->
  <script src="https://unpkg.com/xterm@4.11.0/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
  <script src="https://unpkg.com/xterm-addon-web-links@0.4.0/lib/xterm-addon-web-links.js"></script>
  <script src="https://unpkg.com/xterm-addon-search@0.8.0/lib/xterm-addon-sear
ch.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

  <script>
    function init() {
      const term = new Terminal({
        cursorBlink: true,
        macOptionIsMeta: true,
        scrollback: true,
      });

      // https://github.com/xtermjs/xterm.js/issues/2941
      const fit = new FitAddon.FitAddon();
      term.loadAddon(fit);
      term.loadAddon(new WebLinksAddon.WebLinksAddon());
      term.loadAddon(new SearchAddon.SearchAddon());

      term.open(document.getElementById("terminal"));
      fit.fit();
      term.resize(12, 50);
      console.log(`size: ${term.cols} columns, ${term.rows} rows`);
      fit.fit();
      term.writeln("Welcome to pyxterm.js!");
      term.writeln("https://github.com/cs01/pyxterm.js");
      term.onData((data) => {
        console.log("key pressed in browser:", data);
        if (socket) {
          socket.emit("pty-input", {
            input: data
          });
        } else {
          Edrys.sendMessage("input", data)
        }
      });

      const socket = Edrys.role === "station" ? io.connect("/pty") : null;
      const status = document.getElementById("status");
      var connected = false
      var lastData = null

      if (Edrys.role === "station") {
        socket.on("pty-output", function (data) {
          console.log("new output received from server:", data.output);
          term.write(data.output);

          Edrys.sendMessage("pty-output", data.output)
          lastData = data.output
        });

        socket.on("connect", () => {
          fitToscreen();
          status.innerHTML =
            '<span style="background-color: lightgreen;">connected</span>';

          Edrys.sendMessage("connect", "true")
          connected = true
        });

        socket.on("disconnect", () => {
          status.innerHTML =
            '<span style="background-color: #ff8383;">disconnected</span>';

          Edrys.sendMessage("connect", "false")
          connected = false
        });

        Edrys.onMessage(({
          from,
          subject,
          body
        }) => {
          console.log("Got new message: ", from, subject, body)

          switch (subject) {
            case "input": {
              socket.emit("pty-input", {
                input: body
              });
              break
            }

            case "join": {
              Edrys.sendMessage("connect", JSON.stringify(connected))
              Edrys.sendMessage("pty-output", lastData)
              break
            }

            default: {
              console.warn("unknown command: ", from, subject, body)
            }
          }
        });

      } else {
        Edrys.onMessage(({
          from,
          subject,
          body
        }) => {
          console.log("Got new message: ", from, subject, body)

          switch (subject) {
            case "pty-output": {
              term.write(body);
              break
            }

            case "connect": {
              if (body === "true") {
                status.innerHTML =
                  '<span style="background-color: lightgreen;">connected</span>';
              } else {
                status.innerHTML =
                  '<span style="background-color: #ff8383;">disconnected</span>';
              }

              fitToscreen()
            }
          }
        });
      }

      function fitToscreen() {
        fit.fit();
        const dims = {
          cols: term.cols,
          rows: term.rows
        };

        console.log("sending new dimensions to server's pty", dims);
        if (socket) {
          socket.emit("resize", dims);
        }
      }

      function debounce(func, wait_ms) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait_ms);
        };
      }

      const wait_ms = 50;
      window.onresize = debounce(fitToscreen, wait_ms);
    }



    Edrys.onReady(() => {
      console.log("Module is loaded!")

      init()

      if (Edrys.role !== "station") {
        Edrys.sendMessage("join", null)
      }
    });
  </script>
</body>

</html>