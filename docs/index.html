<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>pyxterm.js</title>
  <style>
    html {
      font-family: arial;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/xterm@4.11.0/css/xterm.css" />

  <script defer src="https://edrys-org.github.io/edrys/module/vendor/alpine.min.js"></script>
  <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/water.min.css" />
  <link rel="stylesheet" href="https://edrys-org.github.io/edrys/module/vendor/open-iconic/css/open-iconic.min.css" />
  <script src="https://edrys-org.github.io/edrys/module/edrys.js"></script>

</head>

<body>
  <span style="font-size: 1.4em">pyxterm.js</span>&nbsp;&nbsp;&nbsp;
  <span style="font-size: small">status:
    <span style="font-size: small" id="status">connecting...</span>
  </span>

  <span style="font-size: small; float: inline-end; padding-top: 0.4rem; display: none;" id="control">
    <label>
      student: <input type="checkbox" onclick="toggle('student')">
    </label>

    <label>
      teacher: <input type="checkbox" onclick="toggle('teacher')">
    </label>
  </span>

  <textarea id="execute" style="display: none">echo $CODE | base64 --decode</textarea>

  <div style="width: calc(100% + 10px); height: 80%" id="terminal"></div>

  <p style="text-align: right; font-size: small">
    built by <a href="https://chadsmith.dev">Chad Smith</a>
    <a href="https://github.com/cs01">GitHub</a>
  </p>
  <!-- xterm -->
  <script src="https://unpkg.com/xterm@4.11.0/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
  <script src="https://unpkg.com/xterm-addon-web-links@0.4.0/lib/xterm-addon-web-links.js"></script>
  <script src="https://unpkg.com/xterm-addon-search@0.8.0/lib/xterm-addon-sear
ch.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

  <script>
    var teacher = false
    var student = false
    var editor = false

    function toggle(role) {
      switch (role) {
        case "teacher": {
          teacher = !teacher
          break
        }
        case "student": {
          student = !student
          break
        }
      }
    }

    function execute(code) {
      let program = document.getElementById("execute").value

      if(!program.endsWith("\n")){
        program += "\n"
      }

      Edrys.sendMessage("input_" + Edrys.role, program.replace('$CODE', btoa(code))  )
    }

    function init() {

      // display control only to station
      if (Edrys.role === "station") {
        document.getElementById("control").style.display = "inline-block"

        document.getElementById("execute").style.display = "inline-block"
      }

      const term = new Terminal({
        cursorBlink: true,
        macOptionIsMeta: true,
        scrollback: true,
      });

      // https://github.com/xtermjs/xterm.js/issues/2941
      const fit = new FitAddon.FitAddon();
      term.loadAddon(fit);
      term.loadAddon(new WebLinksAddon.WebLinksAddon());
      term.loadAddon(new SearchAddon.SearchAddon());

      term.open(document.getElementById("terminal"));
      fit.fit();
      term.resize(12, 50);
      console.log(`size: ${term.cols} columns, ${term.rows} rows`);
      fit.fit();
      term.writeln("Welcome to pyxterm.js!");
      term.writeln("https://github.com/cs01/pyxterm.js");
      term.onData((data) => {
        console.log("key pressed in browser:", data);
        if (socket) {
          socket.emit("pty-input", {
            input: data
          });
        } else {
          // send inputData from subRoles
          Edrys.sendMessage("input_" + Edrys.role, data)
        }
      });

      const socket = Edrys.role === "station" ? io.connect(Edrys.module.stationConfig.server || "/pty") : null;
      const status = document.getElementById("status");
      var connected = false
      var lastData = null

      if (Edrys.role === "station") {
        socket.on("pty-output", function (data) {
          console.log("new output received from server:", data.output);
          term.write(data.output);

          Edrys.sendMessage("pty-output", data.output)
          lastData = data.output
        });

        socket.on("connect", () => {
          fitToscreen();
          status.innerHTML =
            '<span style="background-color: lightgreen;">connected</span>';

          Edrys.sendMessage("connect", "true")
          connected = true
        });

        socket.on("disconnect", () => {
          status.innerHTML =
            '<span style="background-color: #ff8383;">disconnected</span>';

          Edrys.sendMessage("connect", "false")
          connected = false
        });

        Edrys.onMessage(({
          from,
          subject,
          body
        }) => {
          // console.log("Got new message: ", from, subject, body)

          switch (subject) {
            case "input_teacher": {
              if (teacher) {
                socket.emit("pty-input", {
                  input: body
                });
              }
              break
            }

            case "input_student": {
              if (student) {
                socket.emit("pty-input", {
                  input: body
                });
              }
              break
            }

            case "input_station": {
              socket.emit("pty-input", {
                input: body
              });

              break
            }

            case "join": {
              Edrys.sendMessage("connect", JSON.stringify(connected))
              Edrys.sendMessage("pty-output", lastData)
              break
            }
          }
        });

        Edrys.onMessage(
          ({
            from,
            subject,
            body,
            module
          }) => {
            // console.log("Got new message: ", from, subject, body, module,  Edrys.module.stationConfig.execute)

            if (subject === Edrys.module.stationConfig.execute) {
              execute(body)
            }
          }, promiscuous = true);
      } else {
        Edrys.onMessage(({
          from,
          subject,
          body
        }) => {
          // console.log("Got new message: ", from, subject, body)

          switch (subject) {
            case "pty-output": {
              term.write(body);
              break
            }

            case "connect": {
              if (body === "true") {
                status.innerHTML =
                  '<span style="background-color: lightgreen;">connected</span>';
              } else {
                status.innerHTML =
                  '<span style="background-color: #ff8383;">disconnected</span>';
              }

              fitToscreen()
            }
          }
        });
      }

      function fitToscreen() {
        fit.fit();
        const dims = {
          cols: term.cols,
          rows: term.rows
        };

        console.log("sending new dimensions to server's pty", dims);
        if (socket) {
          socket.emit("resize", dims);
        }
      }

      function debounce(func, wait_ms) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait_ms);
        };
      }

      const wait_ms = 50;
      window.onresize = debounce(fitToscreen, wait_ms);
    }



    Edrys.onReady(() => {
      console.log("Module is loaded!")

      init()

      if (Edrys.role !== "station") {
        Edrys.sendMessage("join", null)
      }
    });
  </script>
</body>

</html>